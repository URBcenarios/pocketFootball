<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2e8b57">

    <title>Pocket Football V3</title>
    <style>
        body { margin: 0; background-color: #222; overflow: hidden; font-family: sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }
        canvas { display: block; margin: 0 auto; background: #2e8b57; }

        /* Placar */
        #hud {
            position: absolute; top: 10px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 30px;
            color: white; font-weight: 900; font-size: 28px;
            text-shadow: 2px 2px 0px black; pointer-events: none; z-index: 5;
        }
        .blue { color: #3498db; }
        .red { color: #e74c3c; }

        /* Mensagens de Gol/Falta */
        #status-msg {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            font-size: 40px; color: yellow; font-weight: 900;
            text-shadow: 0 0 15px black; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; text-align: center; white-space: nowrap;
        }

        /* Área de Controles */
        #controls {
            position: absolute; bottom: 20px; width: 100%; height: 180px;
            pointer-events: auto; display: flex; justify-content: space-between; align-items: center;
            padding: 0 40px; box-sizing: border-box;
        }

        /* Joystick (Esquerda) */
        #dpad-area {
            width: 140px; height: 140px; background: rgba(255,255,255,0.1);
            border-radius: 50%; position: relative; border: 2px solid rgba(255,255,255,0.2);
        }
        #dpad-stick {
            width: 60px; height: 60px; background: rgba(255,255,255,0.4);
            border-radius: 50%; position: absolute; top: 40px; left: 40px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: transform 0.05s; /* Suaviza visualmente */
        }

        /* Botão de Ação (Direita) */
        #btn-action {
            width: 110px; height: 110px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #c0392b);
            border: 4px solid white;
            color: white; font-weight: 900; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 6px 0 #7f1d1d, 0 10px 10px rgba(0,0,0,0.4);
            transform: translateY(0); transition: all 0.1s;
        }
        #btn-action:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #7f1d1d, 0 0 5px rgba(0,0,0,0.4);
        }

    </style>
</head>
<body>

    <div id="hud">
        <span class="blue" id="scoreBlue">0</span>
        <span>x</span>
        <span class="red" id="scoreRed">0</span>
    </div>

    <div id="status-msg">GOOOL!</div>

    <canvas id="gameCanvas"></canvas>

    <div id="controls">
        <div id="dpad-area">
            <div id="dpad-stick"></div>
        </div>
        <div id="btn-action">CHUTE</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status-msg');
        const scoreBlueEl = document.getElementById('scoreBlue');
        const scoreRedEl = document.getElementById('scoreRed');
        const btnAction = document.getElementById('btn-action');

        let width, height;

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- CONFIGURAÇÕES DE JOGO ---
        const PLAYER_R = 20;    // Tamanho do Jogador
        const BALL_R = 10;      // Tamanho da Bola
        const GOAL_W = 140;     // Largura do Gol
        const FRICTION = 0.97;  // Bola para devagar
        const PLAYER_SPEED = 3.5; // VELOCIDADE REDUZIDA (Era 5)
        const SHOOT_POWER = 18; // Força do chute

        // --- ESTADO ---
        let scoreBlue = 0;
        let scoreRed = 0;
        let possession = 'blue';

        const ball = { x: 0, y: 0, vx: 0, vy: 0 };

        // 0: User (Linha), 1: User GK, 2: CPU (Linha), 3: CPU GK
        let players = [];

        function initGame() {
            resetPositions('blue'); // Azul começa
        }

        function resetPositions(teamStart) {
            possession = teamStart;
            showMessage(teamStart === 'blue' ? "SEU ATAQUE" : "DEFENDA!");

            // -- TIME AZUL (VOCÊ) --
            // Jogador de Linha (Você)
            players[0] = { x: width/2, y: height/2 + 80, team: 'blue', role: 'user', angle: -Math.PI/2, slide: 0 };
            // Goleiro Azul
            players[1] = { x: width/2, y: height - 60, team: 'blue', role: 'gk', angle: -Math.PI/2, slide: 0 };

            // -- TIME VERMELHO (CPU) --
            // Jogador de Linha (CPU)
            players[2] = { x: width/2, y: height/2 - 80, team: 'red', role: 'cpu', angle: Math.PI/2, slide: 0 };
            // Goleiro Vermelho
            players[3] = { x: width/2, y: 60, team: 'red', role: 'gk', angle: Math.PI/2, slide: 0 };

            // Bola no meio
            ball.vx = 0; ball.vy = 0;
            if (teamStart === 'blue') {
                ball.x = players[0].x; ball.y = players[0].y - 30;
            } else {
                ball.x = players[2].x; ball.y = players[2].y + 30;
                // Ajuste para CPU atacar
                players[2].y = height/2 - 50;
                players[0].y = height - 150;
            }
        }

        function showMessage(text) {
            statusEl.innerText = text;
            statusEl.style.opacity = 1;
            setTimeout(() => statusEl.style.opacity = 0, 2000);
        }

        // --- CONTROLES ---
        let joystick = { active: false, x: 0, y: 0, angle: 0 };
        const dpadArea = document.getElementById('dpad-area');
        const stick = document.getElementById('dpad-stick');

        // Joystick Logic
        function handleJoy(touch) {
            const rect = dpadArea.getBoundingClientRect();
            const centerX = rect.left + rect.width/2;
            const centerY = rect.top + rect.height/2;
            let dx = touch.clientX - centerX;
            let dy = touch.clientY - centerY;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const maxDist = 40;

            joystick.angle = Math.atan2(dy, dx);
            if (dist > maxDist) {
                dx = Math.cos(joystick.angle) * maxDist;
                dy = Math.sin(joystick.angle) * maxDist;
            }
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            joystick.active = true;
            joystick.x = dx / maxDist;
            joystick.y = dy / maxDist;
        }

        dpadArea.addEventListener('touchstart', (e) => { e.preventDefault(); handleJoy(e.touches[0]); }, {passive: false});
        dpadArea.addEventListener('touchmove', (e) => { e.preventDefault(); handleJoy(e.touches[0]); }, {passive: false});
        dpadArea.addEventListener('touchend', (e) => {
            e.preventDefault();
            joystick.active = false; joystick.x = 0; joystick.y = 0;
            stick.style.transform = `translate(0px, 0px)`;
        });

        // Botão de Ação Único
        function triggerAction() {
            const p = players[0]; // Você

            // Verifica distância da bola
            const dx = ball.x - p.x;
            const dy = ball.y - p.y;
            const dist = Math.sqrt(dx*dx + dy*dy);

            // Se estiver perto (raio do jogador + bola + margem), CHUTA
            if (dist < PLAYER_R + BALL_R + 25) {
                // Direção do chute: Joystick ou Frente do jogador
                let ang = joystick.active ? joystick.angle : p.angle;

                // Força do chute
                ball.vx = Math.cos(ang) * SHOOT_POWER;
                ball.vy = Math.sin(ang) * SHOOT_POWER;

                // Feedback visual (tremor leve)
                btnAction.innerText = "BUM!";
                setTimeout(() => btnAction.innerText = "CHUTE", 500);
            } else {
                // Se estiver longe, CARRINHO (Dash)
                p.slide = 20; // 20 frames deslizando rápido
            }
        }

        btnAction.addEventListener('touchstart', (e) => { e.preventDefault(); triggerAction(); });
        btnAction.addEventListener('mousedown', (e) => { e.preventDefault(); triggerAction(); });

        // --- LOOP PRINCIPAL ---
        function update() {
            // Bola Física
            ball.x += ball.vx;
            ball.y += ball.vy;
            ball.vx *= FRICTION;
            ball.vy *= FRICTION;

            // Bola Paredes
            if(ball.x < BALL_R || ball.x > width - BALL_R) ball.vx *= -1;
            if(ball.y < BALL_R || ball.y > height - BALL_R) ball.vy *= -1;

            // Atualiza Jogadores
            players.forEach(p => {
                // --- MOVIMENTO USER ---
                if (p.role === 'user') {
                    if (p.slide > 0) {
                        // Carrinho: Vai muito rápido na direção atual
                        p.slide--;
                        p.x += Math.cos(p.angle) * (PLAYER_SPEED * 2.5);
                        p.y += Math.sin(p.angle) * (PLAYER_SPEED * 2.5);
                    } else if (joystick.active) {
                        // Movimento Normal: Mais suave
                        p.x += joystick.x * PLAYER_SPEED;
                        p.y += joystick.y * PLAYER_SPEED;
                        p.angle = joystick.angle;
                    }
                }
                // --- IA DO GOLEIRO (AMBOS) ---
                else if (p.role === 'gk') {
                    // Segue a bola no eixo X
                    let targetX = ball.x;
                    // Trava na pequena área
                    if (targetX < width/2 - 60) targetX = width/2 - 60;
                    if (targetX > width/2 + 60) targetX = width/2 + 60;

                    // Suavização do movimento (Lerp)
                    p.x += (targetX - p.x) * 0.08;

                    // Sai um pouco do gol se a bola vier
                    let baseLine = (p.team === 'blue') ? height - 60 : 60;
                    let dangerDist = 150;

                    if (Math.abs(ball.y - baseLine) < dangerDist && Math.abs(ball.x - width/2) < 100) {
                        // Avança pra fechar angulo
                        let advance = (p.team === 'blue') ? -30 : 30;
                        p.y += ( (baseLine + advance) - p.y ) * 0.05;
                    } else {
                        // Volta pra linha
                        p.y += (baseLine - p.y) * 0.05;
                    }
                }
                // --- IA DO INIMIGO (CPU LINHA) ---
                else if (p.role === 'cpu') {
                    // Lógica de ataque e defesa
                    let tx, ty;

                    // CPU tem a posse? (Bola perto dele)
                    let distBall = Math.sqrt((ball.x - p.x)**2 + (ball.y - p.y)**2);
                    let hasBall = distBall < 40;

                    if (hasBall) {
                        // ATACAR: Vai em direção ao gol de baixo
                        tx = width/2;
                        ty = height;

                        // Se estiver perto e alinhado, CHUTA!
                        if (p.y > height/2 && Math.abs(p.x - width/2) < 100) {
                            if (Math.random() < 0.05) { // 5% de chance por frame de chutar
                                let ang = Math.atan2(height - p.y, width/2 - p.x);
                                ball.vx = Math.cos(ang) * SHOOT_POWER;
                                ball.vy = Math.sin(ang) * SHOOT_POWER;
                            }
                        }
                    } else {
                        // DEFENDER: Persegue a bola
                        tx = ball.x;
                        ty = ball.y;
                    }

                    // Move a CPU
                    let dx = tx - p.x; let dy = ty - p.y;
                    let angle = Math.atan2(dy, dx);
                    p.angle = angle;
                    p.x += Math.cos(angle) * (PLAYER_SPEED * 0.9); // CPU um pouco mais lento que user
                    p.y += Math.sin(angle) * (PLAYER_SPEED * 0.9);
                }

                // --- COLISÃO JOGADOR x BOLA ---
                let dx = ball.x - p.x;
                let dy = ball.y - p.y;
                let dist = Math.sqrt(dx*dx + dy*dy);

                if (dist < PLAYER_R + BALL_R) {
                    // Física de empurrão (Bola não gruda)
                    let angle = Math.atan2(dy, dx);
                    let force = 3;

                    // Se for carrinho, chuta forte
                    if (p.role === 'user' && p.slide > 0) force = 10;
                    // Goleiro rebate forte
                    if (p.role === 'gk') force = 8;

                    ball.vx += Math.cos(angle) * force;
                    ball.vy += Math.sin(angle) * force;

                    // Empurra jogador pra trás (feedback físico)
                    p.x -= Math.cos(angle) * 2;
                    p.y -= Math.sin(angle) * 2;
                }

                // Limites do Campo
                if(p.x < 0) p.x = 0; if(p.x > width) p.x = width;
                if(p.y < 0) p.y = 0; if(p.y > height) p.y = height;
            });

            // --- GOLS ---
            // Gol Azul (Topo)
            if (ball.y < 0 && Math.abs(ball.x - width/2) < GOAL_W/2) {
                scoreBlue++; scoreBlueEl.innerText = scoreBlue;
                showMessage("GOL AZUL!");
                ball.y = -1000; setTimeout(() => resetPositions('blue'), 2000); // Quem faz, ataca
            }
            // Gol Vermelho (Baixo)
            if (ball.y > height && Math.abs(ball.x - width/2) < GOAL_W/2) {
                scoreRed++; scoreRedEl.innerText = scoreRed;
                showMessage("GOL CPU!");
                ball.y = 1000; setTimeout(() => resetPositions('red'), 2000);
            }

            // Bola Fora (Laterais do fundo)
            if (ball.y < -20 || ball.y > height + 20) {
                if (ball.y < 0) { // Saiu no fundo do ataque azul
                    showMessage("TIRO DE META"); setTimeout(() => resetPositions('red'), 1500);
                } else { // Saiu no fundo da defesa azul
                    showMessage("ESCANTEIO (CPU)"); setTimeout(() => resetPositions('red'), 1500);
                }
                ball.y = -5000; ball.vx = 0; ball.vy = 0;
            }
        }

        function draw() {
            // Gramado
            ctx.fillStyle = "#2e8b57";
            ctx.fillRect(0, 0, width, height);

            // Linhas
            ctx.strokeStyle = "rgba(255,255,255,0.4)";
            ctx.lineWidth = 4;
            // Grande área (Cima e Baixo)
            ctx.strokeRect(width/2 - 100, 0, 200, 120);
            ctx.strokeRect(width/2 - 100, height-120, 200, 120);
            // Meio Campo
            ctx.beginPath(); ctx.moveTo(0, height/2); ctx.lineTo(width, height/2); ctx.stroke();
            ctx.beginPath(); ctx.arc(width/2, height/2, 60, 0, Math.PI*2); ctx.stroke();

            // Gols (Redes)
            ctx.fillStyle = "rgba(0,0,0,0.3)";
            ctx.fillRect(width/2 - GOAL_W/2, 0, GOAL_W, 20); // Gol CPU
            ctx.fillRect(width/2 - GOAL_W/2, height-20, GOAL_W, 20); // Gol User

            // Jogadores
            players.forEach(p => {
                // Sombra
                ctx.fillStyle = "rgba(0,0,0,0.3)";
                ctx.beginPath(); ctx.arc(p.x+4, p.y+4, PLAYER_R, 0, Math.PI*2); ctx.fill();

                // Cor do time
                let color = (p.team === 'blue') ? "#3498db" : "#e74c3c";
                if (p.role === 'gk') color = "#f1c40f"; // Goleiros Amarelos

                ctx.fillStyle = color;
                ctx.beginPath(); ctx.arc(p.x, p.y, PLAYER_R, 0, Math.PI*2); ctx.fill();

                // Detalhe (Borda para User)
                if (p.role === 'user') {
                    ctx.strokeStyle = "white"; ctx.lineWidth = 4;
                    ctx.beginPath(); ctx.arc(p.x, p.y, PLAYER_R, 0, Math.PI*2); ctx.stroke();

                    // Seta de direção (só pro user)
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p.x + Math.cos(p.angle)*30, p.y + Math.sin(p.angle)*30);
                    ctx.strokeStyle = "rgba(255,255,255,0.5)"; ctx.lineWidth = 2;
                    ctx.stroke();
                }
            });

            // Bola
            ctx.fillStyle = "white";
            ctx.beginPath(); ctx.arc(ball.x, ball.y, BALL_R, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = "black"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(ball.x, ball.y, BALL_R, 0, Math.PI*2); ctx.stroke();
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        initGame();
        loop();

    </script>
</body>
</html>
